### SQL 서브쿼리 사용이 더 나은 경우

>결합과 관련된 쿼리로 결합할 때는 최대한 결합 대상 레코드수를 줄이는 것이 중요한데
>옵티마이저가 이런것을 잘 판별하지 못할 때는 사람이 직접 연산 순서를 명시해주면 좋다.

##### 
```SQL
// ------------------------------------ 1. 결합과 집약 순서 ----------------------------------------- //
회사테이블과 사업소를 관리하는 테이블을 사용해 결합 테스트

//회사 테이블
 co_cd | district
-------+----------
 001   | A
 002   | B
 003   | C
 004   | D

//사업소 테이블
 co_cd | shop_id | emp_nbr | main_flg
-------+---------+---------+----------
 001   | 1       |     300 | Y
 001   | 2       |     400 | N
 001   | 3       |     250 | Y
 002   | 1       |     100 | Y
 002   | 2       |      20 | N
 003   | 1       |     400 | Y
 003   | 2       |     500 | Y
 003   | 3       |     300 | N
 003   | 4       |     200 | Y
 004   | 1       |     999 | Y

- 두 가지 방법

1. 첫 번재는 결합부터 하고 집약을 하는 방법
SELECT C.co_cd, C.district,
       SUM(emp_nbr) AS sum_emp
　FROM Companies C
         INNER JOIN
           Shops S
    ON C.co_cd = S.co_cd
 WHERE main_flg = 'Y'
 GROUP BY C.co_cd;

2. 집약을 먼저 하고 결합하는 방법
SELECT C.co_cd, C.district, sum_emp
　FROM Companies C
         INNER JOIN
          (SELECT co_cd,
                  SUM(emp_nbr) AS sum_emp
             FROM Shops
            WHERE main_flg = 'Y'
            GROUP BY co_cd) CSUM
    ON C.co_cd = CSUM.co_cd;

- 결합 대상 레코드 수
두 가지 방법은 성능적으로 큰 차이를 보일 수 있다.
판단 기준은 바로 대상 레코드 수

첫번재 방법
회사 테이블: 레코드 4개
사업소 테이블: 레코드 10개

두번째 방법
회사 테이블: 레코드 4개
사업소 테이블(CSUM): 4개

CSUM 뷰가 회사 코드로 집약되어 4개로 압축되어 있는데,
이는 첫번째 방법 10개보다 작으므로 결합 비용을 낮출 수 있다.
현재 샘플에서는 실행 속도에 큰 차이가 없지만 데이터 양이 늘어난다면?

회사테이블: 레코드 1,000개
사업소테이블(main_flg='Y'): 레코드 500만개
사업소테이블(CSUM): 레코드 1,000개

회사 테이블의 규모에 비해 사업소 테이블 규모가 매우 크다면, 일단 결합 대상 레코드 수를
집약하는 편이 I/O 비용을 더 줄일 수 있다.

튜닝 선택지 중 하나로 '사전에 결합 레코드 수를 압축한다'라는 방법을 기억하자.
```


